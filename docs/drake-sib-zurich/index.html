<!DOCTYPE html>
<html>
  <head>
    <title>Make-like declarative workflows with</title>
    <meta charset="utf-8">
    <meta name="author" content="Kirill Müller" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
    <script src="libs/htmlwidgets/htmlwidgets.js"></script>
    <link href="libs/vis/vis.css" rel="stylesheet" />
    <script src="libs/vis/vis.min.js"></script>
    <script src="libs/visNetwork-binding/visNetwork.js"></script>
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Make-like declarative workflows with <img src="images/R_logo_45.png" />
### Kirill Müller
### Zurich, 2018-03-05

---




background-image: url(images/the_difference.png)
background-position: 20% 100%
class: right
# Reproducible

### vs.

# Replicable

???

Thank you.  First of all, I'd like to do a small survey, to make sure we're on the same page.  Who has already been

- programmed?
- programmed in R?
- written a function in R?
- installed software?
- compiled software?
- used Make?
- used remake?

Great!  This presentation focuses on the last two points,
I hope this presentation will be useful to you.

I'd like to start with definitions.  What is a "reproducible workflow"?
In the context of research, we must differentiate between "reproducible" and "replicable".

- **Reproducible**: Can obtain same results from same data
- Replicable: Repeating a study gives similar conclusions

Image credit: [xkcd](https://xkcd.com/242/)

---
background-image: url(images/the_difference.png)
background-size: 120%
background-position: 280% 100%

class: inverse, center, right

# Why?

???

Why is running on other people's computers important?

- coworkers, collaborators, peer review
- validation, verification, replication
- different computers for development and analysis
- your future self

---

background-image: url(images/you.png)
background-position: 50% 70%
background-size: 50%
class: center, inverse

???

Remember that time when you noticed that crucial data error two days prior to submission?

---

background-image: url(images/conflicting.png)
background-position: 50% 50%
background-size: contain
class: center

???

There's a certain tension between making a data analysis reproducible, amendable, and fast. Usually it's easy to achieve two of the three goals.

From https://cloud.smartdraw.com/editor.aspx?templateId=bfa3f50a-8818-4119-bd10-997f2ee3f60c#depoId=8495191&amp;credID=-21599641


---

background-image: url(dots/intro.png)
background-size: contain
background-position: 0% 90%

# Other people's computers

- hardware
- software: OS version, R version and packages
    - virtualization
    - containerization
    - [`packrat`](https://rstudio.github.io/packrat/)
    - [MRAN](https://mran.microsoft.com/)
- data: directory paths
    - open data
    - [`here`](https://github.com/krlmlr/here)
- **workflow**: what to do how and when

???

Components of reproducibility
- hardware
- software: OS version, R version and packages
- data: directory paths
- **workflow**: what to run how and when


Describe the process with a simple example:
preparing a report that contains modeling results obtained from raw data.

Cooking a ragout from a piece of raw meat.

Vegetarians, please think of a substitute for the meat.

---

background-image: url(images/manuals.png)
background-position: 50% 50%
background-size: contain
class: center, inverse

# Manuals

???

This is what XKCD has to say about manuals, I think this applies to workflow descriptions as well.

- the simpler the description, the more likely successful
    - open data: download/harvest from web
    - restricted data: operate directly on raw data
    - cleanup scripts, avoid "manual cleaning"
    - model estimation, analysis, ..., final report

- ideally, a single script that runs everything
    - of course, you're doing this already

- unstructured description?

---
background-image: url(dots/linear.png)
background-position: 50% 50%
background-size: contain
class: center, bottom

# A recipe

???

- complete instructions to prepare the meal
- works for humans
- works for computers
- **does not** work well for
    - modification
    - extension
    - learning

---
background-image: url(dots/detailed-rank.png)
background-size: contain
class: center, bottom

# Splitting the recipe

???

- describe as a set of transformations
- each step has inputs, outputs, and uses a **transformation rule**
- the inputs and outputs are called **targets**
- vegetables?

---
background-image: url(dots/vegetables.png)
background-size: contain
class: center, bottom

# Adding vegetables

???

- Easy to extend or modify
- Rules can be reused

---
background-image: url(dots/from-raw.png)
background-size: contain
class: center, bottom

# Putting it all together

???

- Outputs can be combined easily
- Arbitrary complexity

---

background-image: url(dots/full.png)
background-position: 50% 50%
background-size: contain
class: center, bottom

# Dependency graph

???

- where to get food (for a truly reproducible cooking experience)
- arbitrary complexity if the dependency structure doesn't contain cycles
- define process as a directed acyclic graph
- rule-based tools
    - [GNU make](https://www.gnu.org/software/make/manual/make.html)
    - [snakemake](https://snakemake.readthedocs.io/en/stable/)
    - [remake](https://github.com/richfitz/remake#readme) by Rich FitzJohn
    - [drake](https://github.com/ropensci/drake#readme) by Will Landau

---

background-image: url(dots/detailed.png)
background-size: contain
background-position: 0% 90%
# `Makefile`

```Makefile
all: ragout

ragout: fried_meat
⇥       combine --with=vegetables fried_meat &gt; ragout

fried_meat: chopped_meat
⇥       fry --with=oil chopped_meat &gt; fried_meat

chopped_meat: raw_meat
⇥       chop raw_meat &gt; chopped_meat
```

???

- describe rules
- **order** doesn't matter
- redundancy

---

background-image: url(dots/detailed.png)
background-size: contain
background-position: 0% 90%

# `Makefile` with placeholders

```Makefile
all: ragout

ragout: fried_meat
⇥       combine --with=vegetables $&lt; &gt; $@

fried_meat: chopped_meat
⇥       fry --with=oil $&lt; &gt; $@

chopped_meat: raw_meat
⇥       chop $&lt; &gt; $@
```

---

background-image: url(dots/detailed.png)
background-size: contain
background-position: 0% 90%

# `Makefile` with ![](images/R_logo_45.png)?

```Makefile
all: ragout

ragout.rds: fried_meat.rds
⇥       R -q -e 'library(cooking);
                 fried_meat &lt;- readRDS("$&lt;");
                 ragout &lt;- combine(fried_meat, with = vegetables);
                 saveRDS(ragout, "$@")'

fried_meat.rds: ...
```

---

background-image: url(dots/detailed.png)
background-size: contain
background-position: 0% 90%

# `remake.yml`

```yaml
packages:
- cooking

targets:
  all:
    depends: ragout

  ragout:
    command: combine(fried_meat, with = I("vegetables"))

  fried_meat:
    command: fry(chopped_meat, with = I("oil"))

  chopped_meat:
    command: chop("raw_meat.csv")
```


---

background-image: url(dots/detailed.png)
background-size: contain
background-position: 0% 90%





```r
library(drake)
library(cooking)

plan &lt;- drake_plan(
  ragout = combine(fried_meat, with = "vegetables"),
  fried_meat = fry(chopped_meat, with = "oil"),
  chopped_meat = chop(file_in("raw_meat.csv"))
)

plan
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#8a8a8a"&gt;#&amp;nbsp;A&amp;nbsp;tibble:&amp;nbsp;3&amp;nbsp;x&amp;nbsp;2&lt;/span&gt;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;target&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;command&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="font-style:italic"&gt;&lt;span style="color:#8a8a8a"&gt;&amp;lt;chr&amp;gt;&lt;/span&gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="font-style:italic"&gt;&lt;span style="color:#8a8a8a"&gt;&amp;lt;chr&amp;gt;&lt;/span&gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;1&lt;/span&gt;&amp;nbsp;ragout&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="color:#8a8a8a"&gt;"&lt;/span&gt;combine(fried_meat,&amp;nbsp;with&amp;nbsp;=&amp;nbsp;\"vegetables\")&lt;span style="color:#8a8a8a"&gt;"&lt;/span&gt;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;2&lt;/span&gt;&amp;nbsp;fried_meat&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="color:#8a8a8a"&gt;"&lt;/span&gt;fry(chopped_meat,&amp;nbsp;with&amp;nbsp;=&amp;nbsp;\"oil\")&lt;span style="color:#8a8a8a"&gt;"&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;3&lt;/span&gt;&amp;nbsp;chopped_meat&amp;nbsp;&lt;span style="color:#8a8a8a"&gt;"&lt;/span&gt;chop(file_in(\"raw_meat.csv\"))&lt;span style="color:#8a8a8a"&gt;"&lt;/span&gt;&lt;/div&gt;&lt;/code&gt;


???

- the plan is a data frame
- simplest case: static plan
- easy to create dynamic plans

---


background-image: url(dots/detailed.png)
background-size: contain
background-position: 0% 90%

<div id="htmlwidget-ec897849c5c50a6f7846" style="width:700px;height:450px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-ec897849c5c50a6f7846">{"x":{"nodes":{"id":["combine","fry","\"raw_meat.csv\"","chop","chopped_meat","fried_meat","ragout"],"label":["combine","fry","\"raw_meat.csv\"","chop","chopped_meat","fried_meat","ragout"],"status":["imported","imported","imported","imported","outdated","outdated","outdated"],"type":["function","function","file","function","object","object","object"],"level":[0,0,0,0,1,2,3],"font.size":[20,20,20,20,20,20,20],"color":["#1874CD","#1874CD","#1874CD","#1874CD","#000000","#000000","#000000"],"shape":["triangle","triangle","square","triangle","dot","dot","dot"],"hover_label":["function (..., name = \"ragout\") \n{\n    new_food(name, list(...))\n}","function (what, ...) \n{\n    what <- get_what(what)\n    main <- get_main(what)\n    new_food(paste(\"fried\", main), input = list(what, ...), provenance = NULL)\n}","raw meat","function (what, ...) \n{\n    what <- get_what(what)\n    main <- get_main(what)\n    new_food(paste(\"chopped\", main), input = list(what, ...), \n        provenance = NULL)\n}","chop(file_in(\"raw_meat.csv\"))","fry(chopped_meat, with = \"oil\")","combine(fried_meat, with = \"vegetables\")"],"x":[-1,-0.333333333333333,0.333333333333333,1,0.666666666666667,0.333333333333333,0.333333333333333],"y":[-1,-1,-1,-1,-0.333333333333333,0.333333333333333,1]},"edges":{"from":["combine","fried_meat","chopped_meat","fry","\"raw_meat.csv\"","chop"],"to":["ragout","ragout","fried_meat","fried_meat","chopped_meat","chopped_meat"],"arrows":["to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true,"hover":true}},"groups":null,"width":700,"height":450,"idselection":{"enabled":false},"byselection":{"enabled":false},"main":{"text":"Workflow graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Imported","Object","Function","File"],"color":["#000000","#1874CD","#888888","#888888","#888888"],"shape":["dot","dot","dot","triangle","square"],"font.color":["black","black","black","black","black"],"font.size":[20,20,20,20,20],"id":[2,5,7,8,9]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);","events":{"hoverNode":"function(e){\n        var label_info = this.body.data.nodes.get({\n          fields: ['label', 'hover_label'],\n          filter: function (item) {\n            return item.id === e.node\n          },\n          returnType :'Array'\n        });\n        this.body.data.nodes.update({\n          id: e.node,\n          label : label_info[0].hover_label,\n          hover_label : label_info[0].label\n        });\n      }","blurNode":"function(e){\n        var label_info = this.body.data.nodes.get({\n          fields: ['label', 'hover_label'],\n          filter: function (item) {\n            return item.id === e.node\n          },\n          returnType :'Array'\n        });\n        this.body.data.nodes.update({\n          id: e.node,\n          label : label_info[0].hover_label,\n          hover_label : label_info[0].label\n        });\n      }"}},"evals":["events.hoverNode","events.blurNode"],"jsHooks":[]}</script>

---

class: inverse, center, middle

# `drake::make(plan)`

---



```r
make(plan)
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;cache&lt;/span&gt;&amp;nbsp;.../.drake&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;connect&lt;/span&gt;&amp;nbsp;3&amp;nbsp;imports:&amp;nbsp;pre_chunk,&amp;nbsp;colourise_chunk,&amp;nbsp;plan&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;connect&lt;/span&gt;&amp;nbsp;3&amp;nbsp;targets:&amp;nbsp;ragout,&amp;nbsp;fried_meat,&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;4&amp;nbsp;items:&amp;nbsp;file&amp;nbsp;"raw_meat.csv",&amp;nbsp;chop,&amp;nbsp;combine,&amp;nbsp;fry&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#00afff"&gt;target&lt;/span&gt;&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;fried_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#00afff"&gt;target&lt;/span&gt;&amp;nbsp;fried_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;ragout&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#ff5fff"&gt;unload&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#00afff"&gt;target&lt;/span&gt;&amp;nbsp;ragout&lt;/div&gt;&lt;/code&gt;


```r
readd(ragout)
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;cache&lt;/span&gt;&amp;nbsp;.../.drake&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;ragout,&amp;nbsp;&lt;span style="font-style:italic"&gt;made&amp;nbsp;of&lt;/span&gt;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;fried&amp;nbsp;meat,&amp;nbsp;&lt;span style="font-style:italic"&gt;made&amp;nbsp;of&lt;/span&gt;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;chopped&amp;nbsp;meat,&amp;nbsp;&lt;span style="font-style:italic"&gt;made&amp;nbsp;of&lt;/span&gt;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;raw&amp;nbsp;meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;oil&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;vegetables&lt;/div&gt;&lt;/code&gt;


---

<div id="htmlwidget-ac00066e7f6365b7f0d3" style="width:700px;height:450px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-ac00066e7f6365b7f0d3">{"x":{"nodes":{"id":["combine","fry","\"raw_meat.csv\"","chop","chopped_meat","fried_meat","ragout"],"label":["combine","fry","\"raw_meat.csv\"","chop","chopped_meat","fried_meat","ragout"],"status":["imported","imported","imported","imported","up to date","up to date","up to date"],"type":["function","function","file","function","object","object","object"],"level":[0,0,0,0,1,2,3],"font.size":[20,20,20,20,20,20,20],"color":["#1874CD","#1874CD","#1874CD","#1874CD","#228B22","#228B22","#228B22"],"shape":["triangle","triangle","square","triangle","dot","dot","dot"],"hover_label":["function (..., name = \"ragout\") \n{\n    new_food(name, list(...))\n}","function (what, ...) \n{\n    what <- get_what(what)\n    main <- get_main(what)\n    new_food(paste(\"fried\", main), input = list(what, ...), provenance = NULL)\n}","raw meat","function (what, ...) \n{\n    what <- get_what(what)\n    main <- get_main(what)\n    new_food(paste(\"chopped\", main), input = list(what, ...), \n        provenance = NULL)\n}","chop(file_in(\"raw_meat.csv\"))","fry(chopped_meat, with = \"oil\")","combine(fried_meat, with = \"vegetables\")"],"x":[-1,-0.333333333333333,0.333333333333333,1,0.666666666666667,0.333333333333333,0.333333333333333],"y":[-1,-1,-1,-1,-0.333333333333333,0.333333333333333,1]},"edges":{"from":["combine","fried_meat","chopped_meat","fry","\"raw_meat.csv\"","chop"],"to":["ragout","ragout","fried_meat","fried_meat","chopped_meat","chopped_meat"],"arrows":["to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true,"hover":true}},"groups":null,"width":700,"height":450,"idselection":{"enabled":false},"byselection":{"enabled":false},"main":{"text":"Workflow graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Imported","Object","Function","File"],"color":["#228B22","#1874CD","#888888","#888888","#888888"],"shape":["dot","dot","dot","triangle","square"],"font.color":["black","black","black","black","black"],"font.size":[20,20,20,20,20],"id":[1,5,7,8,9]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);","events":{"hoverNode":"function(e){\n        var label_info = this.body.data.nodes.get({\n          fields: ['label', 'hover_label'],\n          filter: function (item) {\n            return item.id === e.node\n          },\n          returnType :'Array'\n        });\n        this.body.data.nodes.update({\n          id: e.node,\n          label : label_info[0].hover_label,\n          hover_label : label_info[0].label\n        });\n      }","blurNode":"function(e){\n        var label_info = this.body.data.nodes.get({\n          fields: ['label', 'hover_label'],\n          filter: function (item) {\n            return item.id === e.node\n          },\n          returnType :'Array'\n        });\n        this.body.data.nodes.update({\n          id: e.node,\n          label : label_info[0].hover_label,\n          hover_label : label_info[0].label\n        });\n      }"}},"evals":["events.hoverNode","events.blurNode"],"jsHooks":[]}</script>

---

# Cooking again?



```r
make(plan)
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;cache&lt;/span&gt;&amp;nbsp;.../.drake&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;connect&lt;/span&gt;&amp;nbsp;3&amp;nbsp;imports:&amp;nbsp;pre_chunk,&amp;nbsp;colourise_chunk,&amp;nbsp;plan&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;connect&lt;/span&gt;&amp;nbsp;3&amp;nbsp;targets:&amp;nbsp;ragout,&amp;nbsp;fried_meat,&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;4&amp;nbsp;items:&amp;nbsp;file&amp;nbsp;"raw_meat.csv",&amp;nbsp;chop,&amp;nbsp;combine,&amp;nbsp;fry&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;fried_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;ragout&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#00afff"&gt;All&amp;nbsp;targets&amp;nbsp;are&amp;nbsp;already&amp;nbsp;up&amp;nbsp;to&amp;nbsp;date.&lt;/span&gt;&lt;/div&gt;&lt;/code&gt;


---


# Spice it up!



```r
plan &lt;- drake_plan(
  ragout = combine(fried_meat, with = "vegetables"),
* fried_meat = fry(chopped_meat, with = c("oil", "pepper")),
  chopped_meat = chop(file_in("raw_meat.csv"))
)
```



---

<div id="htmlwidget-a261f1c13aea9e511342" style="width:700px;height:450px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-a261f1c13aea9e511342">{"x":{"nodes":{"id":["combine","c","fry","\"raw_meat.csv\"","chop","chopped_meat","fried_meat","ragout"],"label":["combine","c","fry","\"raw_meat.csv\"","chop","chopped_meat","fried_meat","ragout"],"status":["imported","imported","imported","imported","imported","up to date","outdated","outdated"],"type":["function","function","function","file","function","object","object","object"],"level":[0,0,0,0,0,1,2,3],"font.size":[20,20,20,20,20,20,20,20],"color":["#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#228B22","#000000","#000000"],"shape":["triangle","triangle","triangle","square","triangle","dot","dot","dot"],"hover_label":["function (..., name = \"ragout\") \n{\n    new_food(name, list(...))\n}",".Primitive(\"c\")","function (what, ...) \n{\n    what <- get_what(what)\n    main <- get_main(what)\n    new_food(paste(\"fried\", main), input = list(what, ...), provenance = NULL)\n}","raw meat","function (what, ...) \n{\n    what <- get_what(what)\n    main <- get_main(what)\n    new_food(paste(\"chopped\", main), input = list(what, ...), \n        provenance = NULL)\n}","chop(file_in(\"raw_meat.csv\"))","fry(chopped_meat, with = c(\"oil\", \"pepper\"))","combine(fried_meat, with = \"vegetables\")"],"x":[-1,-0.5,0,0.5,1,0.75,0,0],"y":[-1,-1,-1,-1,-1,-0.333333333333333,0.333333333333333,1]},"edges":{"from":["combine","fried_meat","c","chopped_meat","fry","\"raw_meat.csv\"","chop"],"to":["ragout","ragout","fried_meat","fried_meat","fried_meat","chopped_meat","chopped_meat"],"arrows":["to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true,"hover":true}},"groups":null,"width":700,"height":450,"idselection":{"enabled":false},"byselection":{"enabled":false},"main":{"text":"Workflow graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Outdated","Imported","Object","Function","File"],"color":["#228B22","#000000","#1874CD","#888888","#888888","#888888"],"shape":["dot","dot","dot","dot","triangle","square"],"font.color":["black","black","black","black","black","black"],"font.size":[20,20,20,20,20,20],"id":[1,2,5,7,8,9]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);","events":{"hoverNode":"function(e){\n        var label_info = this.body.data.nodes.get({\n          fields: ['label', 'hover_label'],\n          filter: function (item) {\n            return item.id === e.node\n          },\n          returnType :'Array'\n        });\n        this.body.data.nodes.update({\n          id: e.node,\n          label : label_info[0].hover_label,\n          hover_label : label_info[0].label\n        });\n      }","blurNode":"function(e){\n        var label_info = this.body.data.nodes.get({\n          fields: ['label', 'hover_label'],\n          filter: function (item) {\n            return item.id === e.node\n          },\n          returnType :'Array'\n        });\n        this.body.data.nodes.update({\n          id: e.node,\n          label : label_info[0].hover_label,\n          hover_label : label_info[0].label\n        });\n      }"}},"evals":["events.hoverNode","events.blurNode"],"jsHooks":[]}</script>

---



```r
make(plan)
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;cache&lt;/span&gt;&amp;nbsp;.../.drake&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;connect&lt;/span&gt;&amp;nbsp;3&amp;nbsp;imports:&amp;nbsp;pre_chunk,&amp;nbsp;colourise_chunk,&amp;nbsp;plan&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;connect&lt;/span&gt;&amp;nbsp;3&amp;nbsp;targets:&amp;nbsp;ragout,&amp;nbsp;fried_meat,&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;5&amp;nbsp;items:&amp;nbsp;file&amp;nbsp;"raw_meat.csv",&amp;nbsp;c,&amp;nbsp;chop,&amp;nbsp;combine,&amp;nbsp;fry&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;fried_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#ffaf00"&gt;load&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#00afff"&gt;target&lt;/span&gt;&amp;nbsp;fried_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;check&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;ragout&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#ff5fff"&gt;unload&lt;/span&gt;&amp;nbsp;1&amp;nbsp;item:&amp;nbsp;chopped_meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#00afff"&gt;target&lt;/span&gt;&amp;nbsp;ragout&lt;/div&gt;&lt;/code&gt;


```r
readd(ragout)
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#afd7d7"&gt;cache&lt;/span&gt;&amp;nbsp;.../.drake&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;ragout,&amp;nbsp;&lt;span style="font-style:italic"&gt;made&amp;nbsp;of&lt;/span&gt;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;fried&amp;nbsp;meat,&amp;nbsp;&lt;span style="font-style:italic"&gt;made&amp;nbsp;of&lt;/span&gt;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;chopped&amp;nbsp;meat,&amp;nbsp;&lt;span style="font-style:italic"&gt;made&amp;nbsp;of&lt;/span&gt;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;raw&amp;nbsp;meat&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;oil&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pepper&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;vegetables&lt;/div&gt;&lt;/code&gt;


---

class: inverse, center, middle

# Running your analysis on other people's computers enables reproducibility.

# &amp;nbsp;

# Describe your analysis as a set of&lt;br/&gt;**data transformations**&lt;br/&gt;to make it easy to run &lt;br/&gt;for you and for others.

---



---

class: center, middle, inverse, title-slide

# Make-like declarative workflows with &lt;img src="images/R_logo_45.png" /&gt;
## Advanced topics
### Kirill Müller
### Zurich, 2018-03-05

---

# Project directory



```r
library(here)
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;here()&amp;nbsp;starts&amp;nbsp;at&amp;nbsp;...&lt;/div&gt;&lt;/code&gt;


```r
dir(here())
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;[1]&amp;nbsp;"cooking-tutorial"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"cooking.Rmd"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;[3]&amp;nbsp;"docs"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"dots"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;[5]&amp;nbsp;"gsp"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"images"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;[7]&amp;nbsp;"index_cache"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"index.Rmd"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;[9]&amp;nbsp;"Makefile"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"notes.md"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;[11]&amp;nbsp;"outline.md"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"packrat"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;[13]&amp;nbsp;"raw_meat.csv"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"remake-slides.Rproj"&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;[15]&amp;nbsp;"remake.yml"&lt;/div&gt;&lt;/code&gt;


```r
here("docs", "index.html")
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;[1]&amp;nbsp;".../docs/index.html"&lt;/div&gt;&lt;/code&gt;


---

# Project directory



```r
dr_here()
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;here()&amp;nbsp;starts&amp;nbsp;at&amp;nbsp;...,&amp;nbsp;because&amp;nbsp;it&amp;nbsp;contains&amp;nbsp;a&amp;nbsp;file&amp;nbsp;matching&amp;nbsp;`[.]Rproj$`&amp;nbsp;with&amp;nbsp;contents&amp;nbsp;matching&amp;nbsp;`^Version:&amp;nbsp;`&amp;nbsp;in&amp;nbsp;the&amp;nbsp;first&amp;nbsp;line&lt;/div&gt;&lt;/code&gt;


## Files outside project directory? Use links!

- URLs
- Windows: `Sys.junction()`
- OS X / Linux: `file.link()`
- `fs::link_create()`

---

# File organization



```r
*drake_example("gsp")
cat(
  system(
*   "tree gsp",
    intern = TRUE),
  sep = "\n"
)
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;gsp&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;├──&amp;nbsp;clean.R&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;├──&amp;nbsp;interactive-tutorial.R&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;├──&amp;nbsp;make.R&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;├──&amp;nbsp;R&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;│  &amp;nbsp;├──&amp;nbsp;functions.R&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;│  &amp;nbsp;├──&amp;nbsp;packages.R&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;│  &amp;nbsp;└──&amp;nbsp;plan.R&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;├──&amp;nbsp;README.md&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;└──&amp;nbsp;report.Rmd&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;1&amp;nbsp;directory,&amp;nbsp;8&amp;nbsp;files&lt;/div&gt;&lt;/code&gt;


---

background-image: url(images/conflicting.png)
background-position: 50% 50%
background-size: contain

# Scalability?

---

# Parallel processing



```r
unlink(".drake", recursive = TRUE)
plan &lt;- drake_plan(
  sleep_1 = Sys.sleep(1),
  sleep_2 = Sys.sleep(2),
  sleep_3 = Sys.sleep(3),
  sleep = list(sleep_1, sleep_2, sleep_3)
)

system.time(make(
  plan, verbose = FALSE
))
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;user&amp;nbsp;&amp;nbsp;system&amp;nbsp;elapsed&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;0.163&amp;nbsp;&amp;nbsp;&amp;nbsp;0.047&amp;nbsp;&amp;nbsp;&amp;nbsp;6.216&lt;/div&gt;&lt;/code&gt;


---

# Parallel processing



```r
unlink(".drake", recursive = TRUE)
plan &lt;- drake_plan(
  sleep_1 = Sys.sleep(1),
  sleep_2 = Sys.sleep(2),
  sleep_3 = Sys.sleep(3),
  sleep = list(sleep_1, sleep_2, sleep_3)
)

system.time(make(
  plan, verbose = FALSE,
* jobs = 4
))
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;user&amp;nbsp;&amp;nbsp;system&amp;nbsp;elapsed&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;0.335&amp;nbsp;&amp;nbsp;&amp;nbsp;0.458&amp;nbsp;&amp;nbsp;&amp;nbsp;3.416&lt;/div&gt;&lt;/code&gt;


---

background-image: url(dots/detailed-validate.png)
background-position: 50% 90%
background-size: contain

# Validation

- Directly at the source
- Usually can be run in parallel to further processing

---

background-image: url(dots/detailed-parallel.png)
background-position: 50% 90%
background-size: contain

# Meta-rules

- `evaluate_plan()` et al.
- tidy evaluation: `!!`
- *dplyr* manipulation
- *data.table* manipulation
- base R manipulation

## Goal: Specify meta-rules in `drake_plan()`

---

# Dynamic plans



```r
plan &lt;-
  fs::dir_ls(type = "file") %&gt;%
  tibble::enframe() %&gt;%
  dplyr::transmute(
    target = paste0("hash_", value),
    command = paste0("digest::digest(file_in('", value, "'))")
  )

plan
```

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#8a8a8a"&gt;#&amp;nbsp;A&amp;nbsp;tibble:&amp;nbsp;8&amp;nbsp;x&amp;nbsp;2&lt;/span&gt;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;target&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;command&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="font-style:italic"&gt;&lt;span style="color:#8a8a8a"&gt;&amp;lt;chr&amp;gt;&lt;/span&gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="font-style:italic"&gt;&lt;span style="color:#8a8a8a"&gt;&amp;lt;chr&amp;gt;&lt;/span&gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;1&lt;/span&gt;&amp;nbsp;hash_Makefile&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;digest::digest(file_in('Makefile'))&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;2&lt;/span&gt;&amp;nbsp;hash_cooking.Rmd&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;digest::digest(file_in('cooking.Rmd'))&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;3&lt;/span&gt;&amp;nbsp;hash_index.Rmd&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;digest::digest(file_in('index.Rmd'))&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;4&lt;/span&gt;&amp;nbsp;hash_notes.md&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;digest::digest(file_in('notes.md'))&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;5&lt;/span&gt;&amp;nbsp;hash_outline.md&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;digest::digest(file_in('outline.md'))&amp;nbsp;&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;6&lt;/span&gt;&amp;nbsp;hash_raw_meat.csv&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;digest::digest(file_in('raw_meat.csv'…&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;7&lt;/span&gt;&amp;nbsp;hash_remake-slides.Rproj&amp;nbsp;digest::digest(file_in('remake-slides…&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style="color:#b2b2b2"&gt;8&lt;/span&gt;&amp;nbsp;hash_remake.yml&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;digest::digest(file_in('remake.yml'))&lt;/div&gt;&lt;/code&gt;


---

# Dynamic plans

&lt;code class="remark-code r"&gt;&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;Warning&amp;nbsp;in&amp;nbsp;repair_target_names(plan$target):&amp;nbsp;replacing&amp;nbsp;illegal&lt;/div&gt;
&lt;div class="remark-code-line"&gt;&lt;span style="color:#8a8a8a"&gt;#&amp;gt;&lt;/span&gt;&amp;nbsp;symbols&amp;nbsp;in&amp;nbsp;target&amp;nbsp;names&amp;nbsp;with&amp;nbsp;'_'.&lt;/div&gt;&lt;/code&gt;
<div id="htmlwidget-e2045036e7a6211c2d88" style="width:700px;height:450px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-e2045036e7a6211c2d88">{"x":{"nodes":{"id":["\"Makefile\"","digest::digest","\"cooking.Rmd\"","\"index.Rmd\"","\"notes.md\"","\"outline.md\"","\"raw_meat.csv\"","\"remake-slides.Rproj\"","\"remake.yml\"","hash_Makefile","hash_cooking.Rmd","hash_index.Rmd","hash_notes.md","hash_outline.md","hash_raw_meat.csv","hash_remake_slides.Rproj","hash_remake.yml"],"label":["\"Makefile\"","digest::digest","\"cooking.Rmd\"","\"index.Rmd\"","\"notes.md\"","\"outline.md\"","\"raw_meat.csv\"","\"remake-slides.Rproj\"","\"remake.yml\"","hash_Makefile","hash_cooking.Rmd","hash_index.Rmd","hash_notes.md","hash_outline.md","hash_raw_meat.csv","hash_remake_slides.Rproj","hash_remake.yml"],"status":["imported","imported","imported","imported","imported","imported","imported","imported","imported","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["file","function","file","file","file","file","file","file","file","object","object","object","object","object","object","object","object"],"level":[0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1],"font.size":[20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20],"color":["#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["square","triangle","square","square","square","square","square","square","square","dot","dot","dot","dot","dot","dot","dot","dot"],"hover_label":["all: docs/index.html docs/cooking.html\n\n.dots: $(patsubst %.dot,%.png,$(wildcard dots/*.dot))\n\ttouch $@\n\ndots/%.png: docs/dots/%.png\n\tln -sf $(PWD)/$< $@\n\ndocs/dots/%.png: dots/%.dot\n\tdot $< -Tpng -o$@","function (object, algo = c(\"md5\", \"sha1\", \"crc32\", \"sha256\", \n    \"sha512\", \"xxhash32\", \"xxhash64\", \"murmur32\"), serialize = TRUE, \n    file = FALSE, length = Inf, skip = \"auto\", ascii = FALSE, \n    raw = FALSE, seed = 0, errormode = c(\"stop\", \"wa...","---\ntitle: \"Make-like declarative workflows with ![](images/R_logo_45.png)\"\nsubtitle: \"Exercises\"\nauthor: \"Kirill Müller\"\ndate: \"Zurich, 2018-03-05\"\noutput:\n  xaringan::moon_reader:\n    lib_dir: docs/libs\n    nature:\n      highlightStyle: github","---\ntitle: \"Make-like declarative workflows with ![](images/R_logo_45.png)\"\nauthor: \"Kirill Müller\"\ndate: \"Zurich, 2018-03-05\"\noutput:\n  xaringan::moon_reader:\n    lib_dir: docs/libs\n    nature:\n      highlightStyle: github\n      highlightLines: true","## 2\n\nI'd like to start with definitions.  What is a \"reproducible workflow\"?\nIn the context of research, we must differentiate between \"reproducible\" and \"replicable\".\n\n- **Reproducible**: Can obtain same results from same data\n- Replicable: Repe...","# 9:00\n\n- hi, welcome\n- check software installation\n- quick survey\n    - used R\n    - written a function in R\n    - used the pipe in R\n    - created a reproducible analysis with R\n    - used GitHub?","raw meat","Version: 1.0\n\nRestoreWorkspace: Default\nSaveWorkspace: Default\nAlwaysSaveHistory: Default\n\nEnableCodeIndexing: Yes\nUseSpacesForTab: Yes\nNumSpacesForTab: 2\nEncoding: UTF-8","packages:\n- cooking\n\ntargets:\n  all:\n    depends: ragout\n\n  ragout:\n    command: combine(fried_meat, with = I(\"vegetables\"))\n","digest::digest(file_in('Makefile'))","digest::digest(file_in('cooking.Rmd'))","digest::digest(file_in('index.Rmd'))","digest::digest(file_in('notes.md'))","digest::digest(file_in('outline.md'))","digest::digest(file_in('raw_meat.csv'))","digest::digest(file_in('remake-slides.Rproj'))","digest::digest(file_in('remake.yml'))"],"x":[-1,0,-0.75,-0.5,-0.25,0.25,0.5,0.75,1,-1,-0.75,-0.5,-0.125,0.125,0.5,0.75,1],"y":[-1,-1,-1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1]},"edges":{"from":["\"Makefile\"","digest::digest","digest::digest","digest::digest","digest::digest","digest::digest","digest::digest","digest::digest","digest::digest","\"cooking.Rmd\"","\"index.Rmd\"","\"notes.md\"","\"outline.md\"","\"raw_meat.csv\"","\"remake-slides.Rproj\"","\"remake.yml\""],"to":["hash_Makefile","hash_Makefile","hash_cooking.Rmd","hash_index.Rmd","hash_notes.md","hash_outline.md","hash_raw_meat.csv","hash_remake_slides.Rproj","hash_remake.yml","hash_cooking.Rmd","hash_index.Rmd","hash_notes.md","hash_outline.md","hash_raw_meat.csv","hash_remake_slides.Rproj","hash_remake.yml"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true,"hover":true}},"groups":null,"width":700,"height":450,"idselection":{"enabled":false},"byselection":{"enabled":false},"main":{"text":"Workflow graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Imported","Object","Function","File"],"color":["#000000","#1874CD","#888888","#888888","#888888"],"shape":["dot","dot","dot","triangle","square"],"font.color":["black","black","black","black","black"],"font.size":[20,20,20,20,20],"id":[2,5,7,8,9]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);","events":{"hoverNode":"function(e){\n        var label_info = this.body.data.nodes.get({\n          fields: ['label', 'hover_label'],\n          filter: function (item) {\n            return item.id === e.node\n          },\n          returnType :'Array'\n        });\n        this.body.data.nodes.update({\n          id: e.node,\n          label : label_info[0].hover_label,\n          hover_label : label_info[0].label\n        });\n      }","blurNode":"function(e){\n        var label_info = this.body.data.nodes.get({\n          fields: ['label', 'hover_label'],\n          filter: function (item) {\n            return item.id === e.node\n          },\n          returnType :'Array'\n        });\n        this.body.data.nodes.update({\n          id: e.node,\n          label : label_info[0].hover_label,\n          hover_label : label_info[0].label\n        });\n      }"}},"evals":["events.hoverNode","events.blurNode"],"jsHooks":[]}</script>

---
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
